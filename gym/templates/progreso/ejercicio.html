{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>üìä Progreso: {{ ejercicio.nombre }}</h1>
        <p class="text-muted">Grupo: {{ ejercicio.get_grupo_muscular_display }}</p>
    </div>
    <div>
        <a href="{% url 'progreso_dashboard' %}" class="btn btn-outline-secondary">
            ‚Ü©Ô∏è Volver al Dashboard
        </a>
    </div>
</div>

{% if historial %}
<!-- Estad√≠sticas del Ejercicio -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card card-dark text-center">
            <div class="card-body">
                {% with ultimo=historial|last %}
                <div class="display-6">{{ ultimo.peso_maximo }}kg</div>
                {% endwith %}
                <small class="text-muted">Peso m√°ximo actual</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card card-dark text-center">
            <div class="card-body">
                {% with primero=historial|first ultimo=historial|last %}
                {% if ultimo.peso_maximo > primero.peso_maximo %}
                <div class="display-6 text-success">+{{ ultimo.peso_maximo|floatformat:1|add:primero.peso_maximo|floatformat:1 }}kg</div>
                {% else %}
                <div class="display-6">{{ ultimo.peso_maximo|floatformat:1|add:primero.peso_maximo|floatformat:1 }}kg</div>
                {% endif %}
                {% endwith %}
                <small class="text-muted">Progreso total</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card card-dark text-center">
            <div class="card-body">
                <div class="display-6">{{ historial|length }}</div>
                <small class="text-muted">Veces realizado</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card card-dark text-center">
            <div class="card-body">
                {% with ultimo=historial|last %}
                <div class="display-6">{{ ultimo.volumen_total|floatformat:0 }}</div>
                {% endwith %}
                <small class="text-muted">Volumen √∫ltimo</small>
            </div>
        </div>
    </div>
</div>

<!-- Historial Detallado -->
<div class="card card-dark mb-4">
    <div class="card-header">
        <h5 class="mb-0">üìã Historial Completo</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Rutina</th>
                        <th>Peso M√°ximo (kg)</th>
                        <th>Reps Totales</th>
                        <th>Series</th>
                        <th>Volumen</th>
                        <th>Progreso vs Anterior</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registro in historial %}
                    <tr>
                        <td>{{ registro.fecha|date:"d/m/Y" }}</td>
                        <td>{{ registro.rutina }}</td>
                        <td class="fw-bold">{{ registro.peso_maximo }}</td>
                        <td>{{ registro.reps_totales }}</td>
                        <td>{{ registro.series_completadas }}</td>
                        <td>{{ registro.volumen_total|floatformat:0 }}</td>
                        <td>
                            {% if not forloop.first %}
                                {% with prev=historial|slice:forloop.counter0|first %}
                                    {% if registro.peso_maximo > prev.peso_maximo %}
                                        <span class="text-success">‚ÜóÔ∏è +{{ registro.peso_maximo|floatformat:1|add:prev.peso_maximo|floatformat:1 }}kg</span>
                                    {% elif registro.peso_maximo < prev.peso_maximo %}
                                        <span class="text-danger">‚ÜòÔ∏è {{ registro.peso_maximo|floatformat:1|add:prev.peso_maximo|floatformat:1 }}kg</span>
                                    {% else %}
                                        <span class="text-muted">‚û°Ô∏è Igual</span>
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                <span class="text-muted">Primera vez</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Gr√°fico Simple (Tabla) -->
<!-- Solo Tabla (Sin gr√°ficos complicados) -->
{% if datos_grafico %}
<div class="card card-dark">
    <div class="card-header">
        <h5 class="mb-0">üìà Historial de Peso</h5>
    </div>
    <div class="card-body">
        <table class="table table-dark">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Peso M√°x</th>
                    <th>Progreso</th>
                </tr>
            </thead>
            <tbody>
                {% for dato in datos_grafico %}
                <tr>
                    <td>{{ dato.fecha }}</td>
                    <td><strong>{{ dato.peso_maximo }}kg</strong></td>
                    <td>
                        {% if not forloop.first %}
                            <span class="badge bg-primary">
                                Registro {{ forloop.counter }}
                            </span>
                        {% else %}
                            <span class="text-muted">Inicio</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}









{% else %}
<!-- Mensaje si no hay historial -->
<div class="card card-dark text-center py-5">
    <div class="card-body">
        <h4>üìù Sin historial para este ejercicio</h4>
        <p class="text-muted">A√∫n no has registrado entrenamientos con este ejercicio</p>
        <a href="{% url 'lista_rutinas' %}" class="btn btn-primary">
            üèãÔ∏è‚Äç‚ôÇÔ∏è Comenzar a Entrenar
        </a>
    </div>
</div>
{% endif %}
{% endblock %}